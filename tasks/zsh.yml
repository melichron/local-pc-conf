- name: Clone Oh-My-ZSH if not present
  ansible.builtin.command: "git clone -c core.autocrlf=input --depth=1 https://github.com/ohmyzsh/ohmyzsh .oh-my-zsh"
  args:
    chdir: "{{ item }}"
    creates: "{{ item }}/.oh-my-zsh"
  tags:
    # Suppress warning: [ANSIBLE0006] git used in place of git module
    # Git module doesn't allow us to set `core.autocrlf=input`.
    - skip_ansible_lint
  loop:
    - "{{ lookup('env', 'HOME') }}"
  register: ohmyzshinstall

- name: Clone powerlevel10k repo
  ansible.builtin.git:
    repo: 'https://github.com/romkatv/powerlevel10k.git'
    dest: "{{ item }}/.oh-my-zsh/custom/themes/powerlevel10k"
    single_branch: true
    version: "v1.19.0"
  when: ohmyzshinstall is success
  loop:
    - "{{ lookup('env', 'HOME') }}"
  register: powerlevel10krepo

- name: Ensure completions and functions dir
  ansible.builtin.file:
    path: "{{ item.0 }}/.oh-my-zsh/{{ item.1 }}"
    state: directory
    mode: '1755'
  loop: "{{ root_folders | product(zsh_folders) | list }}"
  vars:
    root_folders:
      - "{{ lookup('env', 'HOME') }}"
    zsh_folders:
      - "completions"
      - "functions"
  register: zsh_dirs
  when: ohmyzshinstall is success

- name: Clone zsh-autosuggestions repo
  ansible.builtin.git:
    repo: "https://github.com/zsh-users/zsh-autosuggestions"
    dest: "{{ item }}/.oh-my-zsh/custom/plugins/zsh-autosuggestions"
    single_branch: true
    version: "v0.7.0"
  when: ohmyzshinstall is success
  loop:
    - "{{ lookup('env', 'HOME') }}"
  register: zsh_autosuggestions

- name: Ensure powerlevel10k theme settings file
  ansible.builtin.copy:
    src: p10k.zsh
    dest: "{{ item }}/.p10k.zsh"
    mode: '0664'
  loop:
    - "{{ lookup('env', 'HOME') }}"
  when: powerlevel10krepo is success

- name: Set the aliases list
  ansible.builtin.set_fact:
    zsh_aliases:
      - alias nullrepo='git add . && git stash && git stash drop'
      - alias ap='ansible-playbook '
      - alias logvault="vault login -method=userpass username=${USER}"
      - alias ccat='pygmentize -g '
      - alias showcert='openssl x509 -text -noout -in '
      - alias xx='sudo -s --shell /bin/zsh'
      - alias ..="cd .."
      - alias ...="cd ../../"
      - alias gtc='git add . && git commit -m "`curl -s http://whatthecommit.com/index.txt`" && git push'
      - alias gsv='git status -vv'
      - alias gsvv='git status -v'
      - alias cgd='if git rev-parse --is-inside-work-tree -q 2>&1 >/dev/null; then cd $(git rev-parse --show-toplevel); else echo "Not in Git repository!"; fi'
      - alias hs='hub sync'
      - alias senv='source bin/activate'
      - alias kkk='kubectl get pods'
      - alias sz='source ~/.zshrc'
      - alias hh='history | grep '
      - alias stg='find . -type d -name ".terragrunt-cache"'
      - alias dtg='find . -type d -name ".terragrunt-cache" -prune -exec rm -rf {} \;'
      - alias kx='kubectx -'
      - alias kb='kubectx '
      - alias km='kubens '
      - alias kn='kubens -'
      - alias kl='kubie ns'
      - alias ko='kubie ctx'
      - alias ctg='find . -type d -name .terragrunt-cache | xargs rm -rfv - && git clean -xdf'

- name: Define .zshrc from template
  ansible.builtin.template:
    dest: "{{ item }}/.zshrc"
    src: zshrc.j2
    mode: '0664'
  loop:
    - "{{ lookup('env', 'HOME') }}"
  when: ohmyzshinstall is success
  register: copyzshrc
