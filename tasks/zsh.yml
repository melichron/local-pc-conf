- name: Install packages for ZSH
  ansible.builtin.package:
    name:
      - "zsh"
      - "powerline"
      - "git"
      - "python3-pygments"
    state: latest
  become: true
  tags:
    # Suppress warning: Package installs should not use latest.
    - skip_ansible_lint

- name: Clone Oh-My-ZSH if not present
  ansible.builtin.command: "git clone -c core.autocrlf=input --depth=1 https://github.com/ohmyzsh/ohmyzsh .oh-my-zsh"
  args:
    chdir: "{{ item }}"
    creates: "{{ item }}/.oh-my-zsh"
  tags:
    # Suppress warning: [ANSIBLE0006] git used in place of git module
    # Git module doesn't allow us to set `core.autocrlf=input`.
    - skip_ansible_lint
  loop:
    - "/root"
    - "/etc/skel"
  register: ohmyzshinstall
  become: true

- name: Clone powerlevel10k repo
  ansible.builtin.git:
    repo: 'https://github.com/romkatv/powerlevel10k.git'
    dest: "{{ item }}/.oh-my-zsh/custom/themes/powerlevel10k"
    version: "v1.19.0"
  when: ohmyzshinstall is success
  loop:
    - "/etc/skel"
    - "/root"
  register: powerlevel10krepo
  become: true

- name: Ensure completions and functions dir
  ansible.builtin.file:
    path: "{{ item.0 }}/.oh-my-zsh/{{ item.1 }}"
    state: directory
    mode: '1755'
  loop: "{{ root_folders | product(zsh_folders) | list }}"
  vars:
    root_folders:
      - "/root"
      - "/etc/skel"
    zsh_folders:
      - "completions"
      - "functions"
  become: true
  register: zsh_dirs
  when: ohmyzshinstall is success

- name: Clone zsh-autosuggestions repo
  ansible.builtin.git:
    repo: "https://github.com/zsh-users/zsh-autosuggestions"
    dest: "{{ item }}/.oh-my-zsh/custom/plugins/zsh-autosuggestions"
    version: "v0.7.0"
  become: true
  when: ohmyzshinstall is success
  loop:
    - "/root"
    - "/etc/skel"
  register: zsh_autosuggestions

- name: Ensure powerlevel10k theme settings file
  ansible.builtin.copy:
    src: p10k.zsh
    dest: "{{ item }}/.p10k.zsh"
    mode: '0644'
  loop:
    - "/root"
    - "/etc/skel"
  when: powerlevel10krepo is success
  become: true

- name: Set the aliases list
  ansible.builtin.set_fact:
    zsh_aliases:
      - alias nullrepo='git add . && git stash && git stash drop'
      - alias ap='ansible-playbook'
      - alias logvault="vault login -method=userpass username=${USER}"
      - alias ccat='pygmentize -g '
      - alias showcert='openssl x509 -text -noout -in '
      - alias xx='sudo -s --shell /bin/zsh'
      - alias ..="cd .."
      - alias ...="cd ../../"
      - alias gtc='git add . && git commit -m "`curl -s http://whatthecommit.com/index.txt`" && git push'
      - alias gsv='git status -vv'
      - alias cgd='if git rev-parse --is-inside-work-tree -q 2>&1 >/dev/null; then cd $(git rev-parse --show-toplevel); else echo "Not in Git repository!"; fi'

- name: Set the folder shortcut list
  ansible.builtin.set_fact:
    zsh_folder_shortcuts:
      - hash -d volumes=/var/lib/docker/volumes

- name: Define .zshrc from template
  ansible.builtin.template:
    dest: "{{ item }}/.zshrc"
    src: zshrc.j2
    mode: '0664'
  loop:
    - "/root"
    - "/etc/skel"
  when: ohmyzshinstall is success
  register: copyzshrc
  become: true
